var c=AgoraRTC.createClient({mode:"rtc",codec:"vp8"});let n;const u="https://saavn.me/search/songs?query=";let R=document.getElementById("audio");var s={videoTrack:null,audioTrack:null,audioTrack:null,audioEffectTrack:null};var l=50;var M={videoTrackMuted:false,audioTrackMuted:false};let i=false;let r;var e={};var o={appid:null,channel:null,uid:null,token:null};var d={state:"IDLE",duration:0};const f=$(".play");let t;const p="wss://free.blr2.piesocket.com/v3/1?api_key=BFJuJjDOkT7B7lKD6WodSFPXAAo123lItRb771JN&notify_self=1";const m={create3:async a=>{await L(a.key,a.channel,a.uid)},play1:a=>w(a.url,a.type),volume1:a=>y(a.volume),mute1:async a=>{await j()},unmute1:async a=>{await B()},stop1:async a=>{await v()}};function k(a,e){if(a in m){m[a](e)}}function g(a){try{const t=JSON.parse(a);if(t&&t.selenium){const{key:o,data:i}=t.selenium;if(o&&i){console.log(`RESPONSE (as object):`,t);if(n==i.chatId){k(o,i)}}}}catch(e){console.error(`RESPONSE (not a valid JSON): ${a}`)}}function a(){try{const e=new WebSocket(p);e.onmessage=a=>g(a.data);console.log("[socket][start] Socket Started")}catch(a){console.error(a)}}a();$(()=>{var a=new URL(location.href).searchParams;o.appid=a.get("appid");o.channel=a.get("channel");o.token=a.get("token");o.uid=a.get("uid");if(o.appid&&o.channel){$("#uid").val(o.uid);$("#appid").val(o.appid);$("#token").val(o.token);$("#channel").val(o.channel);$("#join-form").submit()}});$("#mute-audio").click(async function(a){await j()});$("#unmute-audio").click(async function(a){await B()});$("#resume").click(function(a){A()});$("#pause").click(function(a){E()});$("#join-form").submit(async function(a){a.preventDefault();$("#join").attr("disabled",true);try{o.channel=$("#channel").val();o.uid=Number($("#uid").val());o.appid=$("#appid").val();o.token=$("#token").val();console.log(o.channel);n=o.channel.replace("-AUDIO","");console.log(n);await S();if(o.token){$("#success-alert-with-token").css("display","block")}else{$("#success-alert a").attr("href",`index.html?appid=${o.appid}&channel=${o.channel}&token=${o.token}`);$("#success-alert").css("display","block")}}catch(e){console.error(e)}finally{$("#leave").attr("disabled",false);$("#audio-mixing").attr("disabled",false);$("#audio-effect").attr("disabled",false);$("#stop-audio-mixing").attr("disabled",false);$("#local-audio-mixing").attr("disabled",false)}});$("#leave").click(async function(a){O()});$("#audio-mixing").click(function(a){b()});$("#audio-effect").click(async function(a){await x(1,{source:"audio.mp3"});console.log("play audio effect success")});$("#stop-audio-mixing").click(async function(a){T();await j();return false});$(".audio-bar .progress").click(function(a){h(a.offsetX);return false});$("#volume").click(function(a){y($("#volume").val())});$("#local-audio-mixing").click(async function(a){var e=document.getElementById("urlInput");var t=e.value;if(t){console.log(t);await w(t)}});f.click(function(){if(d.state==="IDLE"||d.state==="LOADING")return;toggleAudioMixing();return false});function h(a){if(d.state==="IDLE"||d.state==="LOADING")return;const e=a/$(".progress").width();s.audioTrack.seekAudioBuffer(e*d.duration)}function y(a){s.audioTrack.setVolume(parseInt(a));l=a;console.log(a)}async function b(a){if(d.state==="PLAYING"||d.state==="LOADING")return;const e={};if(a){e.source=a}else{e.source="HeroicAdventure.mp3"}try{d.state="LOADING";if(s.audioTrack){await c.unpublish(s.audioTrack)}s.audioTrack=await AgoraRTC.createBufferSourceAudioTrack(e);await c.publish(s.audioTrack);s.audioTrack.play();s.audioTrack.startProcessAudioBuffer({loop:true});d.duration=s.audioTrack.duration;$(".audio-duration").text(C(d.duration));f.toggleClass("active",true);I();d.state="PLAYING";console.log("start audio mixing")}catch(t){d.state="IDLE";console.error(t)}}async function v(){if(s.audioTrack){await c.unpublish(s.audioTrack)}}async function w(a,e){var t;if(s.audioTrack){await c.unpublish(s.audioTrack)}console.log(a);const o=document.getElementById("sample-audio");if(e=="yt"){t="https://streanwer-0d475b960871.herokuapp.com/get_audio?ytlink="+a}else{const i=await fetch(a);console.log(i);if(!i.ok){throw new Error(`Failed to fetch video URL. Status: ${i.status}`)}const n=await i.blob();t=URL.createObjectURL(n);console.log(t)}o.src=t;await o.play().then(async function(){var a=navigator.userAgent.indexOf("Firefox")>-1?o.mozCaptureStream():o.captureStream();[s.audioTrack]=await Promise.all([AgoraRTC.createCustomAudioTrack({mediaStreamTrack:a.getAudioTracks()[0]})]);await c.publish(s.audioTrack);y(l)})}function T(){if(d.state==="IDLE"||d.state==="LOADING")return;d.state="IDLE";s.audioTrack.stopProcessAudioBuffer();s.audioTrack.stop();$(".progress-bar").css("width","0%");$(".audio-current-time").text(C(0));$(".audio-duration").text(C(0));f.toggleClass("active",false);cancelAnimationFrame(t);console.log("stop audio mixing")}function A(){s.audioTrack.resumeProcessAudioBuffer();d.state="PLAYING"}function E(){s.audioTrack.pauseProcessAudioBuffer();d.state="PAUSE"}function G(a){const e=document.getElementById("p-bar");e.style.width=`${a}%`;e.setAttribute("aria-valuenow",a)}function I(){t=requestAnimationFrame(I);const a=s.audioTrack.getCurrentTime();$(".progress-bar").css("width",`${a/d.duration*100}%`);$(".audio-current-time").text(C(a))}async function x(a,e){if(s.audioEffectTrack){await c.unpublish(s.audioEffectTrack)}s.audioEffectTrack=await AgoraRTC.createBufferSourceAudioTrack(e);await c.publish(s.audioEffectTrack);s.audioEffectTrack.play();s.audioEffectTrack.startProcessAudioBuffer({cycle:a})}async function L(a,e,t){c.on("user-published",D);c.on("user-unpublished",P);[o.uid]=await Promise.all([c.join("2b0567d3ff534f0593528432dac20dc1",e,a||null,t||null)]);await c.publish(Object.values(s).filter(a=>a!==null));console.log("publish success")}async function S(){c.on("user-published",D);c.on("user-unpublished",P);[o.uid]=await Promise.all([c.join("2b0567d3ff534f0593528432dac20dc1",o.channel,o.token||null,o.uid||null)]);await c.publish(Object.values(s).filter(a=>a!==null));console.log("publish success")}async function O(){T();for(trackName in s){var a=s[trackName];if(a){a.stop();a.close();s[trackName]=null}}e={};$("#remote-playerlist").html("");await c.leave();$("#local-player-name").text("");$("#join").attr("disabled",false);$("#leave").attr("disabled",true);$("#audio-mixing").attr("disabled",true);$("#audio-effect").attr("disabled",true);$("#stop-audio-mixing").attr("disabled",true);$("#local-audio-mixing").attr("disabled",true);console.log("client leaves channel success")}function F(a,e){const o=e.split(" ");const i={};a.forEach(a=>{const e=o.indexOf(a);if(e!==-1&&e!==o.length-1){const t=o.slice(e+1);i[a]=t.join(" ")}else{i[a]=null}});return i}function U(e,t){let o=0;return async function(){const a=(new Date).getTime();if(a-o<=2e3){await N(e,t)}o=a}}async function N(a,e){await c.subscribe(a,"audio");let t=document.createElement("audio");t.id=a.uid;document.body.appendChild(t);let o=new MediaStream;o.addTrack(a.audioTrack.getMediaStreamTrack());t.srcObject=o;recordinguser=a.uid;a.audioTrack.play();console.log("audio enabled for "+a.uid)}async function D(a,e){console.log("dddd");const t=a.uid;await N(a,e);J(a.uid)}function P(a,e){let t=document.getElementById(a.uid);if(t){t.parentNode.removeChild(t)}const o=a.uid}function J(o){if(!i){let a=document.getElementById(o);let e=a.srcObject;r=new MediaRecorder(e);let t=[];r.ondataavailable=function(a){if(a.data.size>0){t.push(a.data)}};r.onstop=function(){_(t)};r.start();i=true;setTimeout(Y,4e3)}}function _(a){let t=new FormData;a.forEach((a,e)=>{t.append("audio_chunks",a,`chunk_${e}.webm`)});fetch("https://speech2txt-00dfc093af6a.herokuapp.com/upload",{method:"POST",body:t}).then(a=>a.json()).then(async a=>{console.log(a.status);if(a.status=="ok"){var e=a.message;const n=["play","volume"];const c=F(n,a.message);console.log(c);console.log(e);if(e.toLowerCase().includes("mute")){j();console.log("Mute")}if(e.toLowerCase().includes("unmute")){B()}if(e.toLowerCase().includes("stop song")){v()}if(c.play!==null){try{var t=await fetch(u+c.play)}catch(i){console.log(i)}var o=await t.json();var o=o.data.results;w(o[0].downloadUrl[4].link)}if(c.volume!==null){y(c.volume)}}})["catch"](a=>{console.error("Error:",a)})}function Y(){if(i){r.stop();i=false}}async function j(){s.audioTrack.setMuted(true)}async function B(){s.audioTrack.setMuted(false)}function C(a){let e=parseInt(a/60);let t=parseInt(a%60);e=e<10?"0"+e:e;t=t<10?"0"+t:t;return`${e}:${t}`}
