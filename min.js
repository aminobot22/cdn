var c=AgoraRTC.t({mode:"rtc",o:"vp8"});let i;const s="https://saavn.me/search/songs?query=";let F=document.getElementById("audio");var u={i:null,u:null,u:null,l:null};var l=50;var M={m:false,$:false};let o=false;let r;var n={};var t={p:null,channel:null,h:null,v:null};var f={state:"IDLE",duration:0};const d=$(".play");let e;const m="wss://free.blr2.piesocket.com/v3/1?api_key=BFJuJjDOkT7B7lKD6WodSFPXAAo123lItRb771JN&notify_self=1";const p={k:async a=>{await x(a.key,a.channel,a.h)},g:a=>g(a.url,a.type),A:a=>h(a.volume),I:async a=>{await R()},L:async a=>{await j()},N:async a=>{await k()}};function w(a,n){if(a in p){p[a](n)}}function y(a){try{const e=JSON.parse(a);if(e&&e.D){const{key:t,data:o}=e.D;if(t&&o){console.log(`RESPONSE (as object):`,e);if(i==o.S){w(t,o)}}}}catch(n){console.error(`RESPONSE (not a valid JSON): ${a}`)}}function a(){try{const n=new WebSocket(m);n.onmessage=a=>y(a.data);console.log("[socket][start] Socket Started")}catch(a){console.error(a)}}a();$(()=>{var a=new URL(location.href).searchParams;t.p=a.get("appid");t.channel=a.get("channel");t.v=a.get("token");t.h=a.get("uid");if(t.p&&t.channel){$("#uid").O(t.h);$("#appid").O(t.p);$("#token").O(t.v);$("#channel").O(t.channel);$("#join-form").submit()}});$("#mute-audio").click(async function(a){await R()});$("#unmute-audio").click(async function(a){await j()});$("#resume").click(function(a){I()});$("#pause").click(function(a){L()});$("#join-form").submit(async function(a){a.preventDefault();$("#join").T("disabled",true);try{t.channel=$("#channel").O();t.h=Number($("#uid").O());t.p=$("#appid").O();t.v=$("#token").O();console.log(t.channel);i=t.channel.replace("-AUDIO","");console.log(i);await S();if(t.v){$("#success-alert-with-token").P("display","block")}else{$("#success-alert a").T("href",`index.html?appid=${t.p}&channel=${t.channel}&token=${t.v}`);$("#success-alert").P("display","block")}}catch(n){console.error(n)}finally{$("#leave").T("disabled",false);$("#audio-mixing").T("disabled",false);$("#audio-effect").T("disabled",false);$("#stop-audio-mixing").T("disabled",false);$("#local-audio-mixing").T("disabled",false)}});$("#leave").click(async function(a){E()});$("#audio-mixing").click(function(a){v()});$("#audio-effect").click(async function(a){await D(1,{source:"audio.mp3"});console.log("play audio effect success")});$("#stop-audio-mixing").click(async function(a){A();await R();return false});$(".audio-bar .progress").click(function(a){b(a.offsetX);return false});$("#volume").click(function(a){h($("#volume").O())});$("#local-audio-mixing").click(async function(a){var n=document.getElementById("urlInput");var e=n.value;if(e){console.log(e);await g(e)}});d.click(function(){if(f.state==="IDLE"||f.state==="LOADING")return;toggleAudioMixing();return false});function b(a){if(f.state==="IDLE"||f.state==="LOADING")return;const n=a/$(".progress").width();u.u.R(n*f.duration)}function h(a){u.u.j(parseInt(a));l=a;console.log(a)}async function v(a){if(f.state==="PLAYING"||f.state==="LOADING")return;const n={};if(a){n.source=a}else{n.source="HeroicAdventure.mp3"}try{f.state="LOADING";if(u.u){await c.G(u.u)}u.u=await AgoraRTC.F(n);await c.M(u.u);u.u.play();u.u.J({loop:true});f.duration=u.u.duration;$(".audio-duration").text(G(f.duration));d.U("active",true);N();f.state="PLAYING";console.log("start audio mixing")}catch(e){f.state="IDLE";console.error(e)}}async function k(){if(u.u){await c.G(u.u)}}async function g(a,n){var e;if(u.u){await c.G(u.u)}console.log(a);const t=document.getElementById("sample-audio");if(n=="yt"){e="https://streanwer-0d475b960871.herokuapp.com/get_audio?ytlink="+a}else{const o=await fetch(a);console.log(o);if(!o.ok){throw new Error(`Failed to fetch video URL. Status: ${o.status}`)}const i=await o.blob();e=URL.createObjectURL(i);console.log(e)}t.src=e;await t.play().then(async function(){var a=navigator.userAgent.indexOf("Firefox")>-1?t.mozCaptureStream():t.captureStream();[u.u]=await Promise.all([AgoraRTC._({C:a.getAudioTracks()[0]})]);await c.M(u.u);h(l)})}function A(){if(f.state==="IDLE"||f.state==="LOADING")return;f.state="IDLE";u.u.Y();u.u.stop();$(".progress-bar").P("width","0%");$(".audio-current-time").text(G(0));$(".audio-duration").text(G(0));d.U("active",false);cancelAnimationFrame(e);console.log("stop audio mixing")}function I(){u.u.q();f.state="PLAYING"}function L(){u.u.B();f.state="PAUSE"}function J(a){const n=document.getElementById("p-bar");n.style.width=`${a}%`;n.setAttribute("aria-valuenow",a)}function N(){e=requestAnimationFrame(N);const a=u.u.getCurrentTime();$(".progress-bar").P("width",`${a/f.duration*100}%`);$(".audio-current-time").text(G(a))}async function D(a,n){if(u.l){await c.G(u.l)}u.l=await AgoraRTC.F(n);await c.M(u.l);u.l.play();u.l.J({W:a})}async function x(a,n,e){c.H("user-published",T);c.H("user-unpublished",P);[t.h]=await Promise.all([c.join("2b0567d3ff534f0593528432dac20dc1",n,a||null,e||null)]);await c.M(Object.values(u).filter(a=>a!==null));console.log("publish success")}async function S(){c.H("user-published",T);c.H("user-unpublished",P);[t.h]=await Promise.all([c.join("2b0567d3ff534f0593528432dac20dc1",t.channel,t.v||null,t.h||null)]);await c.M(Object.values(u).filter(a=>a!==null));console.log("publish success")}async function E(){A();for(trackName in u){var a=u[trackName];if(a){a.stop();a.close();u[trackName]=null}}n={};$("#remote-playerlist").K("");await c.X();$("#local-player-name").text("");$("#join").T("disabled",false);$("#leave").T("disabled",true);$("#audio-mixing").T("disabled",true);$("#audio-effect").T("disabled",true);$("#stop-audio-mixing").T("disabled",true);$("#local-audio-mixing").T("disabled",true);console.log("client leaves channel success")}function U(a,n){const t=n.split(" ");const o={};a.forEach(a=>{const n=t.indexOf(a);if(n!==-1&&n!==t.length-1){const e=t.slice(n+1);o[a]=e.join(" ")}else{o[a]=null}});return o}function _(n,e){let t=0;return async function(){const a=(new Date).getTime();if(a-t<=2e3){await O(n,e)}t=a}}async function O(a,n){await c.subscribe(a,"audio");let e=document.createElement("audio");e.id=a.h;document.body.appendChild(e);let t=new MediaStream;t.addTrack(a.u.V());e.srcObject=t;recordinguser=a.h;a.u.play();console.log("audio enabled for "+a.h)}async function T(a,n){console.log("dddd");const e=a.h;await O(a,n);C(a.h)}function P(a,n){let e=document.getElementById(a.h);if(e){e.parentNode.removeChild(e)}const t=a.h}function C(t){if(!o){let a=document.getElementById(t);let n=a.srcObject;r=new MediaRecorder(n);let e=[];r.ondataavailable=function(a){if(a.data.size>0){e.push(a.data)}};r.onstop=function(){Y(e)};r.start();o=true;setTimeout(q,4e3)}}function Y(a){let e=new FormData;a.forEach((a,n)=>{e.append("audio_chunks",a,`chunk_${n}.webm`)});fetch("https://speech2txt-00dfc093af6a.herokuapp.com/upload",{method:"POST",body:e}).then(a=>a.json()).then(async a=>{console.log(a.status);if(a.status=="ok"){var n=a.message;const i=["play","volume"];const c=U(i,a.message);console.log(c);console.log(n);if(n.toLowerCase().includes("mute")){R();console.log("Mute")}if(n.toLowerCase().includes("unmute")){j()}if(n.toLowerCase().includes("stop song")){k()}if(c.play!==null){try{var e=await fetch(s+c.play)}catch(o){console.log(o)}var t=await e.json();var t=t.data.results;g(t[0].Z[4].link)}if(c.volume!==null){h(c.volume)}}})["catch"](a=>{console.error("Error:",a)})}function q(){if(o){r.stop();o=false}}async function R(){u.u.aa(true)}async function j(){u.u.aa(false)}function G(a){let n=parseInt(a/60);let e=parseInt(a%60);n=n<10?"0"+n:n;e=e<10?"0"+e:e;return`${n}:${e}`}
