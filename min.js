var c=AgoraRTC.createClient({mode:"rtc",codec:"vp8"});var e=new URLSearchParams(window.location.search);let i=e.get("chatId");const r="https://saavnapi-nine.vercel.app/song?query=";let u=false;let R=document.getElementById("audio");var s={videoTrack:null,audioTrack:null,audioTrack:null,audioEffectTrack:null};var l=50;var M={videoTrackMuted:false,audioTrackMuted:false};let n=false;let d;var t={};var f={appid:null,channel:null,uid:null,token:null};var o={state:"IDLE",duration:0};const m=$(".play");let a;var p=null;function g(e,t){var a=document.querySelector(".log-entry");if(a){a.remove()}var o=document.createElement("div");o.textContent=e;o.classList.add("log-entry",t);document.getElementById("log").appendChild(o);p=setTimeout(function(){o.style.opacity=0;setTimeout(function(){o.remove()},500)},1e4)}document.getElementById("reconnectBtn").addEventListener("click",function(){g("Attempting to reconnect...","info");y()});document.getElementById("deleteDataBtn").addEventListener("click",function(){g("Deleting data...","error");h()});function k(e){localStorage.removeItem("myData");var t=JSON.stringify(e);localStorage.setItem("myData",t);g("Data saved successfully!","success")}function y(){var e=localStorage.getItem("myData");if(e){try{var t=JSON.parse(e);if(t.token&&t.channel&&t.uid){console.log("Retrieved data:",t);L(t.token,t.channel,t.uid)}else{g("Incomplete data found!","error")}}catch(a){g("Error parsing retrieved data: "+a.message,"error")}}else{g("No data found!","error")}}function h(){localStorage.removeItem("myData");g("Data deleted successfully!","error")}g("waiting for connection","success");const v="wss://";const w="free.blr2.piesocket.com";const b="v3";const G="1";const F="BFJuJjDOkT7B7lKD6WodSFPXAAo123lItRb771JN";const J="1";const U=`${v}${w}/${b}/${G}?api_key=${F}&notify_self=${J}`;const T={create3:async e=>{await L(e.key,e.channel,e.uid)},play1:e=>S(e.url,e.type),volume1:e=>E(e.volume),mute1:async e=>{await C()},unmute1:async e=>{await P()},stop1:async e=>{await I()}};function _(e,t){if(e in T){T[e](t)}}function q(e){try{const a=JSON.parse(e);if(a&&a.selenium){const{key:o,data:n}=a.selenium;if(o&&n){console.log(`RESPONSE (as object):`,a);if(i==n.chatId){g("data received trying to connect","info");_(o,n)}}}}catch(t){console.error(`RESPONSE (not a valid JSON): ${e}`)}}function Y(){try{const t=new WebSocket(U);t.onmessage=e=>q(e.data);console.log("[socket][start] Socket Started")}catch(e){g(e,"error")}}Y();$(()=>{var e=new URL(location.href).searchParams;f.appid=e.get("appid");f.channel=e.get("channel");f.token=e.get("token");f.uid=e.get("uid");if(f.appid&&f.channel){$("#uid").val(f.uid);$("#appid").val(f.appid);$("#token").val(f.token);$("#channel").val(f.channel);$("#join-form").submit()}});$("#mute-audio").click(async function(e){await C()});$("#unmute-audio").click(async function(e){await P()});$("#resume").click(function(e){W()});$("#pause").click(function(e){X()});$("#join-form").submit(async function(e){e.preventDefault();$("#join").attr("disabled",true);try{f.channel=$("#channel").val();f.uid=Number($("#uid").val());f.appid=$("#appid").val();f.token=$("#token").val();console.log(f.channel);i=f.channel.replace("-AUDIO","");console.log(i);await Q();if(f.token){$("#success-alert-with-token").css("display","block")}else{$("#success-alert a").attr("href",`index.html?appid=${f.appid}&channel=${f.channel}&token=${f.token}`);$("#success-alert").css("display","block")}}catch(t){console.error(t)}finally{$("#leave").attr("disabled",false);$("#audio-mixing").attr("disabled",false);$("#audio-effect").attr("disabled",false);$("#stop-audio-mixing").attr("disabled",false);$("#local-audio-mixing").attr("disabled",false)}});$("#leave").click(async function(e){Z()});$("#audio-mixing").click(function(e){V()});$("#audio-effect").click(async function(e){await K(1,{source:"audio.mp3"});console.log("play audio effect success")});$("#stop-audio-mixing").click(async function(e){x();await C();return false});$(".audio-bar .progress").click(function(e){z(e.offsetX);return false});$("#volume").click(function(e){E($("#volume").val())});$("#local-audio-mixing").click(async function(e){var t=document.getElementById("urlInput");var a=t.value;if(a){console.log(a);await S(a)}});m.click(function(){if(o.state==="IDLE"||o.state==="LOADING")return;toggleAudioMixing();return false});function z(e){if(o.state==="IDLE"||o.state==="LOADING")return;const t=e/$(".progress").width();s.audioTrack.seekAudioBuffer(t*o.duration)}function E(e){s.audioTrack.setVolume(parseInt(e));l=e;console.log(e)}async function V(e){if(o.state==="PLAYING"||o.state==="LOADING")return;const t={};if(e){t.source=e}else{t.source="HeroicAdventure.mp3"}try{o.state="LOADING";if(s.audioTrack){await c.unpublish(s.audioTrack)}s.audioTrack=await AgoraRTC.createBufferSourceAudioTrack(t);await c.publish(s.audioTrack);s.audioTrack.play();s.audioTrack.startProcessAudioBuffer({loop:true});o.duration=s.audioTrack.duration;$(".audio-duration").text(j(o.duration));m.toggleClass("active",true);D();o.state="PLAYING";console.log("start audio mixing")}catch(a){o.state="IDLE";console.error(a)}}async function I(){if(s.audioTrack){await c.unpublish(s.audioTrack)}}function A(e){let t=Math.floor(e/60);let a=Math.floor(e%60);if(a<10){a="0"+a}return t+":"+a}async function S(e,t){var a;if(s.audioTrack){await c.unpublish(s.audioTrack)}console.log(e);const o=document.getElementById("sample-audio");if(t=="yt"){a="https://streanwer-0d475b960871.herokuapp.com/get_audio?ytlink="+e}else{const n=await fetch(e);console.log(n);if(!n.ok){throw new Error(`Failed to fetch video URL. Status: ${n.status}`)}const i=await n.blob();a=URL.createObjectURL(i);console.log(a)}o.src=a;o.onloadedmetadata=function(){document.getElementById("total-time").textContent=A(o.duration)};await o.play().then(async function(){var e=navigator.userAgent.indexOf("Firefox")>-1?o.mozCaptureStream():o.captureStream();[s.audioTrack]=await Promise.all([AgoraRTC.createCustomAudioTrack({mediaStreamTrack:e.getAudioTracks()[0]})]);await c.publish(s.audioTrack);E(l);o.ontimeupdate=function(){document.getElementById("current-time").textContent=A(o.currentTime)};o.onended=async function(){await C();console.log("Song ended, audio muted")}})}function x(){if(o.state==="IDLE"||o.state==="LOADING")return;o.state="IDLE";s.audioTrack.stopProcessAudioBuffer();s.audioTrack.stop();$(".progress-bar").css("width","0%");$(".audio-current-time").text(j(0));$(".audio-duration").text(j(0));m.toggleClass("active",false);cancelAnimationFrame(a);console.log("stop audio mixing")}function W(){s.audioTrack.resumeProcessAudioBuffer();o.state="PLAYING"}function X(){s.audioTrack.pauseProcessAudioBuffer();o.state="PAUSE"}function H(e){const t=document.getElementById("p-bar");t.style.width=`${e}%`;t.setAttribute("aria-valuenow",e)}function D(){a=requestAnimationFrame(D);const e=s.audioTrack.getCurrentTime();$(".progress-bar").css("width",`${e/o.duration*100}%`);$(".audio-current-time").text(j(e))}async function K(e,t){if(s.audioEffectTrack){await c.unpublish(s.audioEffectTrack)}s.audioEffectTrack=await AgoraRTC.createBufferSourceAudioTrack(t);await c.publish(s.audioEffectTrack);s.audioEffectTrack.play();s.audioEffectTrack.startProcessAudioBuffer({cycle:e})}async function L(e,t,a){try{c.on("user-published",N);c.on("user-unpublished",O);[f.uid]=await Promise.all([c.join("2b0567d3ff534f0593528432dac20dc1",t,e||null,a||null)]);if(!u){var o={token:e,channel:t,uid:a};k(o);g("data saved","success")}g("Voice connected","success")}catch(n){console.error("Error during join operation:",n);g("Error during join operation: "+n.message,"error")}}async function Q(){c.on("user-published",N);c.on("user-unpublished",O);[f.uid]=await Promise.all([c.join("2b0567d3ff534f0593528432dac20dc1",f.channel,f.token||null,f.uid||null)]);await c.publish(Object.values(s).filter(e=>e!==null));console.log("publish success")}async function Z(){x();for(trackName in s){var e=s[trackName];if(e){e.stop();e.close();s[trackName]=null}}t={};$("#remote-playerlist").html("");await c.leave();$("#local-player-name").text("");$("#join").attr("disabled",false);$("#leave").attr("disabled",true);$("#audio-mixing").attr("disabled",true);$("#audio-effect").attr("disabled",true);$("#stop-audio-mixing").attr("disabled",true);$("#local-audio-mixing").attr("disabled",true);console.log("client leaves channel success")}function ee(e,t){const o=t.split(" ");const n={};e.forEach(e=>{const t=o.indexOf(e);if(t!==-1&&t!==o.length-1){const a=o.slice(t+1);n[e]=a.join(" ")}else{n[e]=null}});return n}function te(t,a){let o=0;return async function(){const e=(new Date).getTime();if(e-o<=2e3){await B(t,a)}o=e}}async function B(e,t){await c.subscribe(e,"audio");let a=document.createElement("audio");a.id=e.uid;document.body.appendChild(a);let o=new MediaStream;o.addTrack(e.audioTrack.getMediaStreamTrack());a.srcObject=o;recordinguser=e.uid;e.audioTrack.play();console.log("audio enabled for "+e.uid)}async function N(e,t){console.log("dddd");const a=e.uid;await B(e,t);ae(e.uid)}function O(e,t){let a=document.getElementById(e.uid);if(a){a.parentNode.removeChild(a)}const o=e.uid}function ae(o){if(!n){let e=document.getElementById(o);let t=e.srcObject;d=new MediaRecorder(t);let a=[];d.ondataavailable=function(e){if(e.data.size>0){a.push(e.data)}};d.onstop=function(){oe(a)};d.start();n=true;setTimeout(ne,4e3)}}function oe(e){let a=new FormData;e.forEach((e,t)=>{a.append("audio_chunks",e,`chunk_${t}.webm`)});fetch("https://speech2txt-00dfc093af6a.herokuapp.com/upload",{method:"POST",body:a}).then(e=>e.json()).then(async e=>{console.log(e);if(e.status==="ok"){var t=e.message;const i=["play","volume"];const c=ee(i,e.message);console.log(c);console.log(t);if(t.toLowerCase().includes("mute")){C();console.log("Mute")}if(t.toLowerCase().includes("unmute")){P()}if(t.toLowerCase().includes("stop song")){I()}if(c.play!==null){try{var a=await fetch(r+c.play);var o=await a.json();S(o[0].media_url)}catch(n){console.log(n)}}if(c.volume!==null){E(c.volume)}}})["catch"](e=>{console.error("Error:",e)})}function ne(){if(n){d.stop();n=false}}async function C(){s.audioTrack.setMuted(true)}async function P(){s.audioTrack.setMuted(false)}function j(e){let t=parseInt(e/60);let a=parseInt(e%60);t=t<10?"0"+t:t;a=a<10?"0"+a:a;return`${t}:${a}`}
